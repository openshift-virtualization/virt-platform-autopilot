# RBAC Generator

Automatically generates RBAC ClusterRole from asset templates.

## Overview

The RBAC generator scans all asset files in `assets/` directory (excluding `assets/crds/`) and extracts the Kubernetes resource types (Group, Version, Kind) to automatically generate the required RBAC permissions in `config/rbac/role.yaml`.

## Usage

```bash
# Generate RBAC from assets
make generate-rbac

# Verify RBAC is up-to-date (CI check)
make verify-rbac
```

## How It Works

### 1. Static Rules (Operator Infrastructure)
These permissions are hardcoded and always included:
- **Nodes** - For hardware detection
- **Events** - For observability and event recording
- **Leases** - For leader election
- **CRDs** - For soft dependency detection

### 2. Dynamic Rules (From Assets)
The generator walks `assets/` directory and:
1. Finds all `.yaml` and `.yaml.tpl` files
2. Preprocesses templates (replaces `{{ ... }}` with dummy values)
3. Parses YAML to extract `apiVersion` and `kind`
4. Deduplicates resources by API group
5. Generates ClusterRole rules with standard verbs: `get`, `list`, `watch`, `create`, `update`, `patch`

### 3. Output Format
```yaml
# AUTO-GENERATED by 'make generate-rbac'
# DO NOT EDIT MANUALLY
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: virt-platform-autopilot-role
rules:
  # ========================================
  # Operator Infrastructure (Static)
  # ========================================
  # Nodes (for hardware detection)
  - apiGroups: [""]
    resources: [nodes]
    verbs: [get, list, watch]
  ...
  # ========================================
  # Managed Resources (Dynamic - from assets/)
  # ========================================
  # HyperConverged
  - apiGroups: [hco.kubevirt.io]
    resources: [hyperconvergeds]
    verbs: [get, list, watch, create, update, patch]
  ...
```

## Adding New Assets

When you add a new asset template:

1. Create the asset file in `assets/` (e.g., `assets/operators/my-operator.yaml.tpl`)
2. Run `make generate-rbac` to update RBAC
3. Commit both the new asset AND the updated `config/rbac/role.yaml`

Example:
```bash
# Add new asset
cat > assets/operators/example.yaml.tpl <<EOF
apiVersion: example.io/v1
kind: Example
metadata:
  name: my-example
spec:
  enabled: true
EOF

# Regenerate RBAC
make generate-rbac

# Verify changes
git diff config/rbac/role.yaml
```

## CI Integration

The `.github/workflows/lint.yml` workflow runs `make verify-rbac` on every PR to ensure:
- RBAC is not manually modified
- RBAC is always in sync with assets

If verification fails:
```
❌ ERROR: RBAC is out of sync with assets!

To fix:
  1. Run: make generate-rbac
  2. Commit the updated config/rbac/role.yaml
```

## Implementation Details

### Deterministic Output (CI-Critical)

The generator produces **100% deterministic output** to enable reliable CI verification. Ordering guarantees:

1. **Static Rules**: Always in the same order (hardcoded)
   - Rule 1: Nodes
   - Rule 2: Events
   - Rule 3: Leases (leader election)
   - Rule 4: CRDs

2. **Dynamic Rules**: Sorted alphabetically
   - API Groups: Alphabetically sorted (`forklift.konveyor.io` < `hco.kubevirt.io` < `metallb.io`)
   - Resources within group: Alphabetically sorted (`machineconfigs` < `kubeletconfigs`)
   - Verbs: Alphabetically sorted (`create` < `get` < `list` < `patch` < `update` < `watch`)

3. **File Processing**: Deterministic via `filepath.WalkDir` (lexical order)

### Template Preprocessing
Templates use Go's `text/template` syntax. The generator replaces all `{{ ... }}` with `"dummy-value"` before YAML parsing to handle template variables.

### Resource Pluralization
The generator pluralizes resource kinds using simple heuristics:
- Standard: `Example` → `examples`
- Special cases: `MachineConfig` → `machineconfigs`, `NodeHealthCheck` → `nodehealthchecks`

### Deduplication
Resources are deduplicated by `apiVersion/kind` to avoid duplicate RBAC rules even if the same resource type appears in multiple assets.

## Troubleshooting

### Generator fails to parse an asset
- Check if the asset has valid YAML syntax
- Template variables should use standard Go template syntax: `{{ .Var }}`
- Multi-document YAML files are supported (split by `---`)

### RBAC verification fails in CI
```bash
# Regenerate locally and check diff
make generate-rbac
git diff config/rbac/role.yaml
```

### Missing permissions for a new resource type
- Verify the asset file exists in `assets/` (not `assets/crds/`)
- Check that the file has `.yaml` or `.yaml.tpl` extension
- Run `make generate-rbac --dry-run` to see if the resource is detected